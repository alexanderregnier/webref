{
  "spec": {
    "title": "Local Network Access",
    "url": "https://wicg.github.io/local-network-access/"
  },
  "algorithms": [
    {
      "name": "determine the IP address space",
      "href": "https://wicg.github.io/local-network-access/#determine-the-ip-address-space",
      "html": "To <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"determine-the-ip-address-space\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">determine the IP address space</dfn> of an IP address\n  <var>address</var>, run the following steps:",
      "rationale": "if",
      "steps": [
        {
          "html": "<p>If <var>address</var> belongs to the <code>::ffff:0:0/96</code> \"IPv4-mapped Address\"\n  address block, then replace <var>address</var> with its embedded IPv4 address.</p>"
        },
        {
          "html": "For each <var>row</var> in the\n  <a href=\"https://wicg.github.io/local-network-access/#non-public-ip-address-blocks\">Non-public IP address blocks\"</a>\n  table:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>address</var> belongs to <var>row</var>’s address block, return <var>row</var>’s\n   address space.</p>"
            }
          ]
        },
        {
          "html": "<p>Return <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#ip-address-space-public\" id=\"ref-for-ip-address-space-public②\">public</a>.</p>"
        }
      ]
    },
    {
      "html": "What follows is a sketch of a potential solution:",
      "rationale": "set",
      "steps": [
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-connection\" id=\"ref-for-concept-connection\">Connection</a> objects are given a new <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"connection\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"IP address space\" id=\"connection-ip-address-space\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">IP\n  address space</dfn> property, initially null. This applies to WebSocket\n  connections too.</p>"
        },
        {
          "html": "A new step is added to the <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-connection-obtain\" id=\"ref-for-concept-connection-obtain①\">obtain a connection</a> algorithm immediately\n  before appending <var>connection</var> to the user agent’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-connection-pool\" id=\"ref-for-concept-connection-pool\">connection pool</a>:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>connection</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#connection-ip-address-space\" id=\"ref-for-connection-ip-address-space\">IP address space</a> to\n  the result of running the <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#determine-the-ip-address-space\" id=\"ref-for-determine-the-ip-address-space\">determine the IP address space</a> algorithm\n  on the IP address of <var>connection</var>’s remote endpoint.</p>"
            }
          ]
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request①\">Request</a> objects are given a new <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"request\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"target IP address space\" id=\"request-target-ip-address-space\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">target IP\n  address space</dfn> property, initially null.</p>"
        },
        {
          "html": "<p><a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-response\" id=\"ref-for-concept-response\">Response</a> objects are given a new\n  <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"response\" data-dfn-type=\"dfn\" data-export=\"\" id=\"response-ip-address-space\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">IP address space</dfn> property, whose value is\n  an <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#ip-address-space\" id=\"ref-for-ip-address-space⑨\">IP address space</a>, initially null.</p>"
        },
        {
          "html": "Define a new <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-export=\"\" id=\"local-network-access-check\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">Local Network Access check</dfn> algorithm.\n  Given a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request②\">request</a> <var>request</var> and a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-connection\" id=\"ref-for-concept-connection①\">connection</a> <var>connection</var>:",
          "rationale": "if",
          "steps": [
            {
              "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin\">origin</a> is a <a data-link-type=\"dfn\" href=\"https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-origin\" id=\"ref-for-potentially-trustworthy-origin\">potentially trustworthy origin</a> and <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-current-url\" id=\"ref-for-concept-request-current-url②\">current URL</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin①\">origin</a>\n  is <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#same-origin\" id=\"ref-for-same-origin\">same origin</a> with <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-origin\" id=\"ref-for-concept-request-origin②\">origin</a>, then return\n  null.</p>"
            },
            {
              "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-policy-container\" id=\"ref-for-concept-request-policy-container①\">policy container</a> is null, then return null.</p>"
            },
            {
              "html": "If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#request-target-ip-address-space\" id=\"ref-for-request-target-ip-address-space\">target IP address space</a> is not null, then:",
              "rationale": "assert",
              "steps": [
                {
                  "html": "<p><a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#assert\" id=\"ref-for-assert\">Assert</a>: <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#request-target-ip-address-space\" id=\"ref-for-request-target-ip-address-space①\">target IP address space</a> is not\n  <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#ip-address-space-public\" id=\"ref-for-ip-address-space-public⑦\">public</a>.</p>"
                },
                {
                  "html": "<p>If <var>connection</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#connection-ip-address-space\" id=\"ref-for-connection-ip-address-space①\">IP address space</a> is not equal to\n  then <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#request-target-ip-address-space\" id=\"ref-for-request-target-ip-address-space②\">target IP address space</a>, then return\n  a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error\">network error</a>.</p>"
                },
                {
                  "html": "<p>Return null.</p>"
                }
              ]
            },
            {
              "html": "If <var>connection</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#connection-ip-address-space\" id=\"ref-for-connection-ip-address-space②\">IP address space</a> is\n  <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#ip-address-space-less-public\" id=\"ref-for-ip-address-space-less-public①\">less public</a> than <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-policy-container\" id=\"ref-for-concept-request-policy-container⑤\">policy container</a>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#policy-container-ip-address-space\" id=\"ref-for-policy-container-ip-address-space①\">IP address space</a>, then:",
              "rationale": "let",
              "steps": [
                {
                  "html": "<p>Let <var>error</var> be a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error①\">network error</a>.</p>"
                },
                {
                  "html": "<p>If <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request-client\" id=\"ref-for-concept-request-client②\">client</a> is not a <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/webappapis.html#secure-context\" id=\"ref-for-secure-context③\">secure context</a>\n  (including if it is null), then return <var>error</var>.</p>"
                },
                {
                  "html": "<p>Set <var>error</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#response-ip-address-space\" id=\"ref-for-response-ip-address-space\">IP address space</a> property to\n  <var>connection</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#connection-ip-address-space\" id=\"ref-for-connection-ip-address-space③\">IP address space</a>.</p>"
                },
                {
                  "html": "TODO: Permission check is sketched out below, wording is still vague",
                  "rationale": "if",
                  "steps": [
                    {
                      "html": "<p>If the initiating origin has been granted the local\n network access permission, return null.</p>"
                    },
                    {
                      "html": "<p>If the initiating origin has been denied the local network\n access permission, return <var>error</var>.</p>"
                    },
                    {
                      "html": "Otherwise, prompt the user:",
                      "rationale": "if",
                      "steps": [
                        {
                          "html": "<p>If the user grants permission, return null.</p>"
                        },
                        {
                          "html": "<p>If the user denies the permission, return <var>error</var>.</p>"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "html": "<p>Return null.</p>"
            }
          ]
        },
        {
          "html": "The <a data-link-type=\"abstract-op\" data-refhint-key=\"0bae0f8d\" href=\"https://fetch.spec.whatwg.org/#concept-fetch\" id=\"ref-for-concept-fetch③\">fetch</a> algorithm is amended to add 2 new steps right after request’s\n  policy container is set:",
          "rationale": "if",
          "steps": [
            {
              "html": "If <var>request</var>’s target IP address space is null:",
              "rationale": "if",
              "steps": [
                {
                  "html": "<p>If <var>request</var>’s URL’s host <em>host</em> is an IP address and the result\n of running the determine the IP address space algorithm on <em>host</em> is\n “local”, then set <em>request</em>’s target IP address space property to\n “local”.</p>"
                },
                {
                  "html": "<p>If <var>request</var>’s URL’s host’s public suffix is <code>\"local\"</code>, then set\n <var>request</var>’s target IP address space property to <code>\"local\"</code>.</p>"
                }
              ]
            },
            {
              "html": "<p>If <var>request</var>’s target IP address space is public, then return a network error.</p>\n       <p>OPEN QUESTION: Do we need this? Under what conditions can this get set to \"public\"?</p>"
            }
          ]
        },
        {
          "html": "The <a data-link-type=\"abstract-op\" href=\"https://fetch.spec.whatwg.org/#concept-http-network-fetch\" id=\"ref-for-concept-http-network-fetch\">HTTP-network fetch</a> algorithm is amended to add 3 new steps right\n  after checking that the newly-obtained <var>connection</var> is not\n  failure:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#response-ip-address-space\" id=\"ref-for-response-ip-address-space①\">IP address space</a> to\n  <var>connection</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#connection-ip-address-space\" id=\"ref-for-connection-ip-address-space④\">IP address space</a>.</p>"
            },
            {
              "html": "<p>Let <var>localNetworkAccessCheckResult</var> be the result of running\n  <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#local-network-access-check\" id=\"ref-for-local-network-access-check\">Local Network Access check</a> for <var>fetchParams</var>’ <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request③\">request</a>  and\n  <var>connection</var>.</p>"
            },
            {
              "html": "<p>If <var>localNetworkAccessCheckResult</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error②\">network error</a>, return\n  <var>localNetworkAccessCheckResult</var>.</p>"
            }
          ]
        },
        {
          "html": "Define a new algorithm called <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-type=\"dfn\" data-noexport=\"\" id=\"http-no-service-worker-fetch\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">HTTP-no-service-worker fetch</dfn>\n  based on the existing steps in <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-http-fetch\" id=\"ref-for-concept-http-fetch\">HTTP fetch</a> that are run if <var>response</var>\n  is still null after handling the fetch via service workers, and amend\n  those slightly as follows:",
          "rationale": "if",
          "steps": [
            {
              "html": "Immediately after running HTTP-network-or-cache fetch:",
              "rationale": "if",
              "steps": [
                {
                  "html": "If <var>response</var> is a <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-network-error\" id=\"ref-for-concept-network-error③\">network error</a> and <var>response</var>’s\n  <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#response-ip-address-space\" id=\"ref-for-response-ip-address-space②\">IP address space</a> is non-null, then:",
                  "rationale": "set",
                  "steps": [
                    {
                      "html": "<p>Set <var>request</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#request-target-ip-address-space\" id=\"ref-for-request-target-ip-address-space③\">target IP address space</a> to\n  <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#response-ip-address-space\" id=\"ref-for-response-ip-address-space③\">IP address space</a>.</p>"
                    },
                    {
                      "html": "<p>Return the result of running <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#http-no-service-worker-fetch\" id=\"ref-for-http-no-service-worker-fetch\">HTTP-no-service-worker fetch</a>\n  given <var>fetchParams</var>.</p>"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "html": "The <a class=\"idl-code\" data-link-type=\"constructor\" href=\"https://fetch.spec.whatwg.org/#dom-request\" id=\"ref-for-dom-request\"><code>new\nRequest(<var>input</var>, <var>init</var>)</code></a> is\nappended with the following step right before setting <a data-link-type=\"dfn\" href=\"https://webidl.spec.whatwg.org/#this\" id=\"ref-for-this\">this</a>’s <a data-link-type=\"dfn\" href=\"https://fetch.spec.whatwg.org/#concept-request\" id=\"ref-for-concept-request⑤\">request</a>\nto <var>request</var>:",
      "rationale": "if",
      "steps": [
        {
          "html": "If <var>init</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/local-network-access/#dom-requestinit-targetaddressspace\" id=\"ref-for-dom-requestinit-targetaddressspace\">targetAddressSpace</a></code>\"] <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#map-exists\" id=\"ref-for-map-exists\">exists</a>, then\n  switch on <var>init</var>[\"<code class=\"idl\"><a data-link-type=\"idl\" href=\"https://wicg.github.io/local-network-access/#dom-requestinit-targetaddressspace\" id=\"ref-for-dom-requestinit-targetaddressspace①\">targetAddressSpace</a></code>\"]:",
          "rationale": ".switch",
          "steps": [
            {
              "operation": "switch",
              "steps": [
                {
                  "case": "public",
                  "html": "Do nothing."
                },
                {
                  "case": "local",
                  "html": "Set <var>request</var>’s targetAddressSpace to <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#ip-address-space-local\" id=\"ref-for-ip-address-space-local②②\">local</a>."
                }
              ]
            }
          ]
        }
      ]
    },
    {
      "html": "To support the checks in <a data-link-type=\"biblio\" href=\"https://wicg.github.io/local-network-access/#biblio-fetch\" title=\"Fetch Standard\">[FETCH]</a>, user\nagents must remember the source IP address space of contexts in which network\nrequests are made. To this effect, the\n<a data-link-type=\"biblio\" href=\"https://wicg.github.io/local-network-access/#biblio-html\" title=\"HTML Standard\">[HTML]</a> specification is patched as\nfollows:",
      "rationale": "set",
      "steps": [
        {
          "html": "<p>A new <dfn class=\"dfn-paneled has-dfn-panel\" data-dfn-for=\"policy container\" data-dfn-type=\"dfn\" data-export=\"\" data-lt=\"IP address space\" id=\"policy-container-ip-address-space\" role=\"button\" aria-expanded=\"false\" tabindex=\"0\">IP address space </dfn> property\n is added to the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#policy-container\" id=\"ref-for-policy-container\">policy container</a> <a data-link-type=\"dfn\" href=\"https://infra.spec.whatwg.org/#struct\" id=\"ref-for-struct\">struct</a>.</p>",
          "ignored": [
            "It is initially public."
          ]
        },
        {
          "html": "An additional step is added to the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#clone-a-policy-container\" id=\"ref-for-clone-a-policy-container\">clone a policy container</a> algorithm:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>clone</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#policy-container-ip-address-space\" id=\"ref-for-policy-container-ip-address-space②\">IP address space</a> to\n  <var>policyContainer</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#policy-container-ip-address-space\" id=\"ref-for-policy-container-ip-address-space③\">IP address space</a>.</p>"
            }
          ]
        },
        {
          "html": "An additional step is added to the <a data-link-type=\"dfn\" href=\"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response\" id=\"ref-for-creating-a-policy-container-from-a-fetch-response\">create a policy container from a fetch response</a>\n algorithm:",
          "rationale": "set",
          "steps": [
            {
              "html": "<p>Set <var>result</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#policy-container-ip-address-space\" id=\"ref-for-policy-container-ip-address-space④\">IP address space</a>\n  to <var>response</var>’s <a data-link-type=\"dfn\" href=\"https://wicg.github.io/local-network-access/#response-ip-address-space\" id=\"ref-for-response-ip-address-space④\">IP address space</a>.</p>"
            }
          ]
        }
      ]
    }
  ]
}